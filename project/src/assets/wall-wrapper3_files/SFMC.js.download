
var modalLoaded = 'false';
sticky = '';

function setCookie(cname,cvalue,exdays) {
  var d = new Date();
  d.setTime(d.getTime() + (exdays*24*60*60*1000));
  var expires = "expires=" + d.toGMTString();
  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

function loadModal(name, wait) {
        modalName = name;
    var sfmcCpgn=getCookie("SFMC_Campaign");
    var formURL = "https://cloud.emails.skechers.com/Forms?Form=" + name;
        var SubKey = getCookie("subscriber_key");
                               
    if (SubKey) {
       formURL += "&bypass=True&ID=" + SubKey;                        
    };
    
    if (sfmcCpgn == "") {
       document.getElementById('cpgframe').src = formURL;
       setTimeout(function(){modal.style.display = "block";},wait);
       modalLoaded = 'true';
    };
};
                               
function loadModal2(name) {
        modalName = name;
       var formURL = "https://cloud.emails.skechers.com/Forms?Form=" + name;
       var SubKey = getCookie("subscriber_key");
                               
       if (SubKey) {
           formURL += "&bypass=True&ID=" + SubKey;                        
       };
        
       if (modalLoaded == 'false') {
          document.getElementById('cpgframe').src = formURL
       }; 
       modal.style.display = "block";
       modalLoaded = 'true';
};

                               
function loadModal3(msg) {
       document.getElementById('cpgdiv3').innerHTML = msg;
       modal3.style.display = "block";
};


var promoSet = "False";
formSubmit = "False";
currentURL = window.location.pathname;


// Get the modal
var modal = document.getElementById('cpgModal');
var modal3 = document.getElementById('cpgModal3');

// Get the button that opens the modal
//var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("cpgclose")[0];
var span3 = document.getElementsByClassName("cpgclose3")[0];

// When the user clicks the button, open the modal 
//btn.onclick = function() {
//    modal.style.display = "block";
//}

// When the user clicks on <span> (x), close the modal
    span.onclick = function() {
          var success = localStorage.getItem("successSrc");
          if (formSubmit == "True") {
             window.location.href = currentURL + "?src=" + success; 
          } else {
            setCookie("SFMC_Campaign", modalName, 30);
            modal.style.display = "none";
          }
     }

    span3.onclick = function() {
        modal3.style.display = "none";
          
    }
  
// When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        var success = localStorage.getItem("successSrc");
        if (event.target == modal) {
           if (formSubmit == "True") {
              setCookie("SFMC_Campaign", modalName, 30);
       window.location.href = currentURL + "?src=" + success; 
           } else {
              setCookie("SFMC_Campaign", modalName, 30);
              modal.style.display = "none";
           }
        } else if (event.target == modal3) {
           modal3.style.display = "none";
        }
     }

// addEventListener support for IE8
   function bindEvent(element, eventName, eventHandler) {
      if (element.addEventListener) {
         element.addEventListener(eventName, eventHandler, false);
      } else if (element.attachEvent) {
         element.attachEvent('on' + eventName, eventHandler);
      }
   }

// Listen to message from child window
   bindEvent(window, 'message', function (e) {  

      if (String(e.data).substring(0,5) == "PROMO") {
          var promoCode = e.data.split("|");
          setCookie("SFMC_Promo", promoCode[1], 30);
          formSubmit = "True";
      } else if (String(e.data) == "SUBMITTED") {
          formSubmit = "True";
      } else if (String(e.data) == "EXISTINGCONTACT") {
          document.getElementById('sfmcPromoHeader').style.display = "none";
          localStorage.setItem("hideBanner","true");
      }
   
   });
  
   window.addEventListener('scroll', function(e) {
          if (sticky == 'True') {
                var scrollDown = 'False';

                if (scrollDown == 'False') {
                  $("#sfmcPromoHeader").prependTo(".c-header-global__navigation__primary.js-header-nav-primary");
                  scrollDown = 'True';
                };

                if($(window).scrollTop() == 0) {
                  $("#sfmcPromoHeader").prependTo(".c-header-global.js-global-header");
                   scrollDown = 'False';
                };
          }
   });
  
function SFMC_Campaign(arr) {
    var dlPageType;
    var sfmcCpgn = getCookie("SFMC_Promo");
    localStorage.setItem("successSrc",arr[0].successSourceCode);
    var width = window.innerWidth; 
    var pagePath = window.location.pathname;
    var ls_navDepth = 0;
    sticky = arr[0].stickyBanner;
    var wait = 0;

    if (arr[0].waitSeconds > 0) { 
        wait = arr[0].waitSeconds * 1000;
    }
    
   // if (typeof window.google_tag_manager['GTM-TDRBQZ'] !== 'undefined') {
   //  var dlPageType = window.google_tag_manager['GTM-TDRBQZ'].dataLayer.get('ecomm_pagetype');
   // }
  
    var hideBanner = localStorage.getItem("hideBanner");
  
    var SubKey = localStorage.getItem("SubKey");  
  
    if (!SubKey) {
       var urlParams = new URLSearchParams(window.location.search)
       SubKey = urlParams.get('SubKey');
       if (SubKey) {
          localStorage.setItem("SubKey",SubKey);
       }
    }
    
    if (arr[0].navDepth > 0) {
       var ls_navDepth = localStorage.getItem("ls_navDepth");
       if (!ls_navDepth) {
          ls_navDepth = 1;
          localStorage.setItem("ls_navDepth", ls_navDepth);
       } else {
          ls_navDepth++;
          localStorage.setItem("ls_navDepth", ls_navDepth);
       };  
    };
     
    if (!hideBanner) {
       $(".skip").hide();
       if (sfmcCpgn) {
		   $('#campaign-skinny-banner').replaceWith("<div id='sfmcPromoHeader' style='width: 100%; background: #0061bd;padding-top: 15px!important; padding-bottom: 5px; text-align:center;'><p style='color: #fff;' >" + arr[0].successMessage + "<b>" + sfmcCpgn + "</b></p></div>");
       } else {
           if (arr[0].active == 'True' && ((arr[0].hideOnKnownCustomer == 'True' && !SubKey) || arr[0].hideOnKnownCustomer == 'False')) {
              if ((arr[0].showOnPage > "" && arr[0].showOnPage != pagePath) || (arr[0].navDepth > 0 && arr[0].navDepth != ls_navDepth) || (arr[0].pageType > "" && arr[0].pageType != dlPageType) || (arr[0].hideOnMobile == 'True' && width <= 767)) {
                 if (arr[0].showBanner == 'True') {
                    $('#campaign-skinny-banner').replaceWith("<div id='sfmcPromoHeader' style='width: 100%; background: #0061bd;padding-top: 10px!important; padding-bottom: 5px;;height:50px;text-align:center;color: #fff;' >" + arr[0].bannerMessage + "<a onclick=\"loadModal2('" + arr[0].form + "')\" href='#'><b style='color: #fff;text-decoration: underline;'>" + arr[0].bannerCTA + "</b></a></p></div>");
                 }
              } else {
                 if (arr[0].showBanner == 'True') {
                    $('#campaign-skinny-banner').replaceWith("<div id='sfmcPromoHeader' style='width: 100%; background: #0061bd;padding-top: 10px!important; padding-bottom: 5px;;height:50px;text-align:center;color: #fff;' ><img alt='' onload=\"loadModal('" + arr[0].form + "'," + wait + ")\" src='https://i.imgur.com/hAV6F86.jpg' height='1' style='display:none;' /><p style='color: #fff;' >" + arr[0].bannerMessage + "<a onclick=\"loadModal2('" + arr[0].form + "')\" href='#'><b style='color: #fff;text-decoration: underline;'>" + arr[0].bannerCTA + "</b></a></p></div>");
                 } else {
                    $( "<img alt='' onload=\"loadModal('" + arr[0].form + "'," + wait + ")\" src='https://i.imgur.com/hAV6F86.jpg' height='1' style='display:none;' />" ).insertAfter( '#campaign-skinny-banner' )
                 }
              }
           }
       }
    }
}

